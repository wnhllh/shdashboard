# 数据缓存系统说明

## 功能概述

我们为网络安全态势感知系统添加了一个智能数据缓存机制，确保即使在后端服务器不可用时，系统仍能正常显示数据。

## 主要特性

### 1. 自动切换机制
- **实时检测**：系统会定期检查后端服务器状态（每30秒）
- **智能切换**：当服务器不可用时，自动切换到本地缓存数据
- **无缝体验**：用户无需手动操作，系统自动处理数据源切换

### 2. 数据缓存管理
- **自动缓存**：成功获取数据后自动保存到本地缓存
- **有效期管理**：缓存数据24小时有效期，超过7天自动清除
- **容量控制**：显示缓存大小，便于监控存储使用情况

### 3. 手动操作功能
- **手动刷新**：强制更新数据并刷新缓存
- **导出备份**：将缓存数据导出为JSON文件
- **导入恢复**：从JSON文件导入数据到缓存
- **清除缓存**：手动清除所有本地缓存数据

## 状态指示器

### 数据源状态
- 🟢 **绿色**：服务器在线，使用实时数据
- 🟡 **黄色**：服务器离线，使用缓存数据
- 🔴 **红色**：服务器离线且无可用缓存

### 缓存状态
- **有效**：缓存数据在24小时有效期内
- **过期**：缓存数据超过24小时但仍可用
- **无缓存**：没有本地缓存数据

## 使用方法

### 1. 查看状态
- 右上角状态指示器显示当前数据源
- 详细信息包含连接状态和数据年龄

### 2. 缓存管理
可以通过设置页面或缓存管理组件进行以下操作：

```typescript
// 获取缓存服务实例
import { getCacheService } from '@/services/dataService';
const cacheService = getCacheService();

// 手动保存数据
cacheService.saveToCache(dashboardData);

// 读取缓存数据
const cachedData = cacheService.getFromCache();

// 检查服务器状态
const isOnline = await cacheService.checkServerHealth();

// 导出数据
cacheService.exportCacheToJSON();
```

### 3. 数据备份与恢复
1. **导出备份**：点击"导出数据"按钮下载JSON备份文件
2. **导入恢复**：点击"导入数据"选择JSON文件恢复数据

## 技术实现

### 核心组件
- `CacheService`: 单例模式的缓存管理服务
- `DataSourceIndicator`: 状态指示器组件
- `CacheManager`: 缓存管理界面组件

### 数据流程
```
后端API → 数据验证 → 缓存存储 → 前端展示
     ↓ (失败时)
  本地缓存 → 数据读取 → 前端展示
```

### 存储机制
- 使用 `localStorage` 进行本地存储
- JSON格式数据结构，包含数据、时间戳和版本信息
- 自动过期清理机制

## 配置选项

### 缓存设置
```typescript
// 缓存有效期（24小时）
private readonly CACHE_DURATION = 24 * 60 * 60 * 1000;

// 最大保存期（7天）
private readonly MAX_CACHE_AGE = 7 * 24 * 60 * 60 * 1000;

// 服务器健康检查超时（5秒）
const timeoutId = setTimeout(() => controller.abort(), 5000);
```

### 检查间隔
- 服务器状态检查：每30秒
- 缓存信息更新：实时更新
- 数据刷新：可配置间隔

## 错误处理

### 常见问题
1. **本地存储限制**：浏览器localStorage容量限制
2. **数据格式错误**：导入JSON文件格式不正确
3. **网络超时**：服务器检查超时处理

### 容错机制
- 所有操作都有try-catch错误处理
- 优雅降级：API失败时自动使用缓存
- 用户反馈：控制台日志和状态提示

## 监控和维护

### 缓存监控
- 缓存大小显示（KB）
- 数据年龄显示（分钟/小时/天）
- 有效性状态检查

### 维护建议
1. 定期检查缓存大小，避免占用过多空间
2. 在系统升级前导出数据备份
3. 监控服务器连接状态，及时处理网络问题

## 安全考虑

### 数据安全
- 缓存数据仅存储在本地浏览器
- 不包含敏感认证信息
- 支持手动清除所有缓存数据

### 隐私保护
- 数据不会发送到第三方服务器
- 用户可以完全控制本地数据
- 导出功能仅在用户主动操作时执行 